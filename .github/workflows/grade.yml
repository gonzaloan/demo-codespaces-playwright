name: Grade Lab

on:
  pull_request:
    branches: [main]

permissions:
  pull-requests: write

jobs:
  grade:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Chromium
        run: npx playwright install --with-deps chromium

      - name: Run grader
        run: npm run grade

      - name: Publish results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs   = require('fs');
            const path = require('path');

            let results;
            try {
              results = JSON.parse(fs.readFileSync('grader-results.json', 'utf-8'));
            } catch (e) {
              await core.summary.addRaw('‚ö†Ô∏è Could not read grader results.').write();
              return;
            }

            // Detect if the student has written any code yet
            const hasStudentFiles = (() => {
              try {
                const src = 'src';
                return (
                  fs.readdirSync(path.join(src, 'pages')).some(f => f.endsWith('.ts')) ||
                  fs.readdirSync(path.join(src, 'tests')).some(f => f.endsWith('.spec.ts')) ||
                  fs.readdirSync(path.join(src, 'data')).some(f => f.endsWith('.json'))
                );
              } catch { return false; }
            })();

            const categoryIcons = {
              'Project Structure Validation': 'üìÅ Structure',
              'Code Quality Validation':      'üîç Code Quality',
              'Test Execution Validation':    '‚ñ∂Ô∏è Execution',
            };

            // Actionable hint per check title (must match test() strings exactly)
            const hints = {
              'pages/ directory exists and has .ts files':
                'Create `src/pages/RegisterPage.ts` with an exported class that wraps Playwright page actions.',
              'tests/ directory exists and has .spec.ts files':
                'Create `src/tests/registration.spec.ts` ‚Äî filename **must** end in `.spec.ts`.',
              'data/ directory exists and has .json files':
                'Create `src/data/user.json` with fields: `firstName`, `lastName`, `email`, `password`.',
              'spec files use expect() assertions':
                'Add assertions such as `await expect(page).toHaveURL(...)` or `await expect(locator).toBeVisible()`.',
              'project uses Playwright locators (getByRole, getByPlaceholder, etc)':
                'Use: `page.getByRole("button", { name: "Register" })`, `page.getByLabel("Email")`, `page.getByPlaceholder("...")`',
              'page classes exist and export a class':
                'Your page file must have: `export class RegisterPage { constructor(private page: Page) {} }`',
              'test data is loaded from JSON files':
                'Keep static config (success messages, page titles) in a JSON file under `src/data/` and import it in your spec.',
              'tests use faker for dynamic data generation':
                'Install and import faker: `import { faker } from "@faker-js/faker"` then use `faker.person.firstName()`, `faker.internet.email()`, etc.',
              'no unused imports detected':
                'Remove any `import { X }` where `X` is never referenced in the file body.',
              'tests navigate to the target application':
                'Call `await page.goto("/")` or use the full URL `https://demo.nopcommerce.com/` in your test.',
              'student tests execute successfully':
                'Run `npm test` locally to see the full error output. Fix all failing assertions before pushing.',
              'HTML reporter is configured':
                "Add `['html', { open: 'never' }]` to the `reporter` array in `playwright.config.ts`.",
            };

            const categories = [];
            for (const fileSuite of results.suites ?? []) {
              for (const describeSuite of fileSuite.suites ?? []) {
                categories.push({ name: describeSuite.title, specs: describeSuite.specs ?? [] });
              }
            }

            const allSpecs    = categories.flatMap(c => c.specs);
            const totalPassed = allSpecs.filter(s => s.ok).length;
            const total       = allSpecs.length;
            const pct         = total > 0 ? Math.round((totalPassed / total) * 100) : 0;

            function progressBar(passed, total) {
              const filled = Math.round((passed / total) * 10);
              return '`' + '‚ñà'.repeat(filled) + '‚ñë'.repeat(10 - filled) + '`';
            }

            function statusMsg(pct) {
              if (pct === 100) return 'üéâ Perfect score! Excellent work!';
              if (pct >= 80)   return 'üî• Almost there ‚Äî just a few more to fix!';
              if (pct >= 50)   return 'üí™ Good progress, keep going!';
              if (pct >= 20)   return 'üöÄ You\'ve started! Keep building.';
              return 'üìù Time to write some code!';
            }

            function extractExecError(spec) {
              const msg = spec.tests?.[0]?.results?.[0]?.error?.message ?? '';
              if (!msg) return '';
              return msg
                .replace(/\x1b\[[0-9;]*m/g, '')
                .split('\n')
                .map(l => l.trim())
                .filter(l => l.length > 0)
                .slice(0, 8)
                .join('\n');
            }

            let md = '## üéì Lab Grader Results\n\n';
            md += `> **Score: ${totalPassed} / ${total} checks passed (${pct}%)** ‚Äî ${statusMsg(pct)}\n`;
            md += `> ${progressBar(totalPassed, total)}\n\n`;
            md += '---\n\n';

            // Show "Getting Started" guide when no student files are found
            if (!hasStudentFiles) {
              md += '### üöÄ Getting Started\n\n';
              md += '*It looks like you haven\'t added any code yet ‚Äî here\'s where to begin:*\n\n';
              md += '1. Read `docs/instructions.md` for the full test scenario\n';
              md += '2. Create your page class ‚Üí `src/pages/RegisterPage.ts`\n';
              md += '3. Create your test data ‚Üí `src/data/user.json`\n';
              md += '4. Write your test spec ‚Üí `src/tests/registration.spec.ts`\n';
              md += '5. Run `npm test` locally to verify before pushing\n\n';
              md += '---\n\n';
            }

            // One collapsible section per category
            for (const cat of categories) {
              const icon        = categoryIcons[cat.name] ?? cat.name;
              const catPassed   = cat.specs.filter(s => s.ok).length;
              const catTotal    = cat.specs.length;
              const summaryIcon = catPassed === catTotal ? '‚úÖ' : catPassed === 0 ? '‚ùå' : '‚ö†Ô∏è';

              md += '<details>\n';
              md += `<summary>${summaryIcon} ${icon} ‚Äî ${catPassed}/${catTotal} passed</summary>\n\n`;
              md += '| Check | | Hint |\n';
              md += '|---|---|---|\n';

              const execErrors = [];
              for (const spec of cat.specs) {
                const status = spec.ok ? '‚úÖ' : '‚ùå';
                const hint   = spec.ok ? '' : (hints[spec.title] ?? '');
                md += `| ${spec.title} | ${status} | ${hint} |\n`;
                if (!spec.ok && cat.name === 'Test Execution Validation') {
                  const err = extractExecError(spec);
                  if (err) execErrors.push({ title: spec.title, err });
                }
              }

              // Show execution error details below the table
              for (const { title, err } of execErrors) {
                md += `\n**Error details ‚Äî "${title}":**\n`;
                md += '```\n' + err + '\n```\n';
              }

              md += '\n</details>\n\n';
            }

            md += '---\n\n';
            md += '### üìö Resources\n\n';
            md += '- [Playwright Locators](https://playwright.dev/docs/locators) ‚Äî `getByRole`, `getByLabel`, `getByPlaceholder`\n';
            md += '- [Page Object Model](https://playwright.dev/docs/pom) ‚Äî how to structure page classes\n';
            md += '- [Assertions reference](https://playwright.dev/docs/test-assertions) ‚Äî how to use `expect()`\n';
            md += '- Lab instructions: `docs/instructions.md`\n';

            await core.summary.addRaw(md).write();

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const prev = comments.find(c => c.user.type === 'Bot' && c.body.includes('Grader Results'));
            if (prev) {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: prev.id,
              });
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: md,
            });

      - name: Upload grader report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: grader-report
          path: grader-report/
          retention-days: 30

      - name: Upload grader results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: grader-results
          path: grader-results.json
          retention-days: 30
